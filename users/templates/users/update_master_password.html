{% extends "passmanager/base.html" %}
{% load crispy_forms_tags %}

{% block title %}Update Master Password{% endblock title %}

{% block content %}
    <form action="{% url 'users:update_master_password' %}" method='POST' class="form">
        {% csrf_token %}
        {{ form|crispy }}

        <!-- dynamic password strength meter -->
        <div class="mt-2">
            <div class="progress" style="height: 8px;">
                <div id="password-strength-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <small id="password-strength-text" class="form-text"></small>
        </div>

        <button name="submit" class="btn btn-dark w-100">Update Master Password</button>
        <input type="hidden" name="next" value="{% url 'passmanager:vault' %}" />
    </form>

    <!-- zxcvbn library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/zxcvbn/4.4.2/zxcvbn.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const pwd = document.getElementById('id_new_password1');
            const bar = document.getElementById('password-strength-bar');
            const text = document.getElementById('password-strength-text');

            const levels = ["Very Weak", "Weak", "Fair", "Good", "Strong"];
            const colors = ["bg-danger", "bg-danger", "bg-warning", "bg-primary", "bg-success"];

            pwd.addEventListener('input', () => {
                const val = pwd.value;
                const result = zxcvbn(val);

                const score = result.score;  // 0 – 4 (=5 levels -> above list)
                const percentage = (score + 1) * 20;

                bar.style.width = percentage + "%";
                bar.className = "progress-bar " + colors[score];
                bar.setAttribute("aria-valuenow", percentage);
                text.textContent = levels[score] + (val ? ` — ${result.feedback.suggestions.join(' ')}` : "");
            });
        });
    </script>
{% endblock content %}
